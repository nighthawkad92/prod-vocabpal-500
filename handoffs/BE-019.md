## 1. Metadata
1. Task ID: BE-019
2. Title: Normalize archive filter parsing + dual-field response contract across teacher endpoints
3. Owner Agent: Backend
4. Handoff Date: 2026-02-27
5. Proposed Next State: `REVIEW`

## 2. Summary of Work
1. What was completed:
- Added shared archive filter parser/applicator with canonical+legacy conflict handling.
- Normalized list/summary/legacy attempts endpoints onto shared parser and explicit 400 conflict errors.
- Kept transition-safe dual response fields for archive/restore mutations (`movedToArchivesCount`+`archivedCount`, `restoredFromArchivesCount`+`restoredCount`, plus both ID arrays).
- Added runtime contract assertions in archive/restore mutation handlers.
- Resolved production schema drift by standardizing DB filtering/mutation on `archived_at` while still returning both response aliases (`archiveAt`, `archivedAt`).
- Added richer Supabase error descriptions for faster triage.
2. What was intentionally not done: No DB schema migration; no business-rule change to archive semantics.

## 3. Files and Artifacts
1. Files changed:
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/_shared/archive_filters.ts`
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/_shared/student.ts`
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/teacher-dashboard-list/index.ts`
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/teacher-dashboard-summary/index.ts`
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/teacher-dashboard-attempts/index.ts`
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/teacher-attempt-archive/index.ts`
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/teacher-attempt-restore/index.ts`
2. New files:
- `/Users/akashdatta/Desktop/prod-vocabpal-baseline-500/supabase/functions/_shared/archive_filters.ts`
3. Commands executed:
- `npm run supabase:functions:deploy:teacher-critical`
- `npx supabase functions deploy student-start-attempt`
- `npx supabase functions deploy student-submit-response`
- `npx supabase functions deploy student-complete-attempt`
- `npx supabase functions deploy teacher-reopen`
- `npx supabase functions deploy teacher-dashboard-attempts`

## 4. Validation Evidence
1. Tests run:
- Manual live API probes for `teacher-dashboard-list` canonical/legacy/archive modes.
- Conflict probes for `archive=...` + `archived=...` mismatches.
2. Test results:
- Canonical/legacy list calls return 200 with consistent counts.
- Conflict calls return 400 with explicit conflict error.
3. Manual checks:
- Verified mutation responses include both canonical+legacy counters and ID arrays.

## 5. Downstream Impact
1. Tasks unblocked: `UI-080`, `QA-073`, `QA-074`.
2. Interfaces changed:
- Canonical `archive=` + legacy `archived=` accepted with conflict detection.
- List rows expose both `archiveAt` and `archivedAt`.
- Archive/restore mutation responses expose both new and legacy counters/ID arrays.
3. Migration or deployment impacts: Edge functions redeployed to project `efbmcxadmdarzlfxjjsd`.

## 6. Open Issues
1. Known issues: Frontend shim should remain for one release cycle until parity is proven by repeated after-deploy runs.
2. Risks: Future backend drift if canary/release gates are bypassed.
3. Follow-up required: Remove shim after sustained parity window (tracked in PM-QA-023).

## 7. Requested PM Action
1. Mark as `DONE`
